<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RetroCam Ultimate</title>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 0. å…¨å±€è®¾ç½® --- */
        :root { --bg:#2b2b2b; --body:#e0e0e0; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
        
        body {
            margin:0; width:100vw; height:100vh; overflow:hidden;
            background: radial-gradient(#333 15%, transparent 16%) 0 0/20px 20px, var(--bg);
            display:flex; flex-direction:column; align-items:center; justify-content:center; /* å‚ç›´å±…ä¸­ */
            font-family:'Roboto Mono', monospace;
        }

        /* --- 1. å¯åŠ¨é®ç½© (æ ¸å¿ƒä¿®å¤: é”™è¯¯å¼•å¯¼) --- */
        #mask {
            position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9999;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            text-align:center; transition:opacity 0.5s; padding: 20px;
        }
        .start-btn {
            padding:15px 40px; border:2px solid #fff; color:#fff; background:transparent;
            font-size:18px; border-radius:30px; margin-top:20px; cursor:pointer;
            transition: 0.2s;
        }
        .start-btn:active { background: #fff; color: #000; }
        
        .error-box {
            margin-top:20px; text-align:left; background:#222; padding:15px; 
            border-radius:8px; border-left:4px solid #ff4757; display:none; width: 100%; max-width: 320px;
        }
        .error-title { color:#ff4757; font-weight:bold; font-size:14px; margin-bottom:5px; display:block; }
        .error-desc { color:#ccc; font-size:12px; line-height:1.5; }
        .album-hint { color:#ffd700; font-size:12px; margin-top:10px; font-weight:bold; text-align:center; display:none;}

        /* --- 2. æ¡Œé¢ä¸ç…§ç‰‡ --- */
        #desk { position:fixed; inset:0; z-index:1; pointer-events:none; }
        .card {
            position:absolute; width:160px; padding:10px 10px 40px 10px; background:#fff;
            box-shadow:0 10px 25px rgba(0,0,0,0.4); border-radius:2px; pointer-events:auto;
            transition: transform 0.1s;
        }
        .card:active { transform: scale(1.05); z-index: 9999 !important; }
        .card img { width:100%; height:140px; object-fit:cover; background:#eee; display:block; }
        .card canvas { position:absolute; bottom:5px; left:0; width:100%; height:35px; }

        /* --- 3. ç›¸æœºå®¹å™¨ (è‡ªé€‚åº”ç¼©æ”¾) --- */
        #cam-root {
            position:relative; width:340px; height:420px; z-index:100;
            display:flex; flex-direction:column; justify-content:flex-end; align-items:center;
            transform-origin:bottom center;
        }
        /* å°å±å¹•è‡ªåŠ¨ç¼©å° */
        @media(max-height:700px){ #cam-root{transform:scale(0.85)} }

        /* --- 4. æœºèº« UI --- */
        .body {
            position:relative; width:340px; height:260px; background:#dcdcdc;
            border-radius:30px; box-shadow:0 20px 50px rgba(0,0,0,0.6); z-index:10;
        }
        /* çš®é©çº¹ç† */
        .skin {
            position:absolute; bottom:0; width:100%; height:170px; background:#1a1a1a;
            border-radius:0 0 30px 30px;
            background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E");
        }
        
        /* é•œå¤´ç»„ */
        .lens {
            position:absolute; top:30px; left:50%; transform:translateX(-50%);
            width:180px; height:180px; border-radius:50%; background:#222;
            box-shadow:0 10px 20px rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:20;
        }
        .ring {
            width:160px; height:160px; border-radius:50%;
            background: conic-gradient(#bbb, #fff, #bbb, #888, #bbb, #fff, #bbb);
            display:flex; justify-content:center; align-items:center;
        }
        .glass {
            width:130px; height:130px; border-radius:50%; background:#000;
            overflow:hidden; border:4px solid #111; position:relative; cursor: pointer;
        }
        video, .preview-img { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); transition:filter 0.3s; }
        .preview-img { transform:none; } 
        
        /* é•œå¤´é•€è†œåå…‰ */
        .coating {
            position:absolute; inset:0; pointer-events:none;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(100,0,220,0.15) 50%, transparent 70%);
        }

        /* å¿«é—¨ */
        .shutter {
            position:absolute; top:-15px; left:40px; width:50px; height:50px; border-radius:50%;
            background:#fff; border:1px solid #ddd; box-shadow:0 5px 10px rgba(0,0,0,0.3);
            display:flex; justify-content:center; align-items:center; z-index:15; cursor: pointer;
        }
        .shutter span { width:36px; height:36px; border-radius:50%; background:radial-gradient(#ff6b6b, #c0392b); transition:0.1s; border: 2px solid #eee;}
        .shutter:active span { transform:scale(0.85); }

        /* å–æ™¯å™¨/é—ªå…‰ç¯ */
        .viewfinder {
            position:absolute; top:25px; right:30px; width:60px; height:35px;
            background:#333; border:2px solid #555; border-radius:4px;
            display:flex; justify-content:center; align-items:center; color:#ff4757; font-weight:bold; font-family:sans-serif;
        }

        /* åº•éƒ¨æŒ‰é’® */
        .ctrls {
            position:absolute; bottom:-30px; width:100%; display:flex; justify-content:center; gap:20px; z-index:30;
        }
        .btn {
            width:44px; height:44px; border-radius:50%; background:#f5f5f5; border: 2px solid #ccc;
            display:flex; justify-content:center; align-items:center; font-size:20px;
            box-shadow:0 4px 8px rgba(0,0,0,0.2); cursor:pointer; transition: 0.1s;
        }
        .btn:active { transform: scale(0.9); }
        .btn.active { color:#c0392b; border:2px solid #fab1a0; }

        /* æ»¤é•œæç¤º */
        #f-tip { position: absolute; top: -50px; width: 100%; text-align: center; color: white; opacity: 0; transition: 0.3s; text-shadow: 0 2px 5px black; font-size: 14px;}
        
        /* å‡ºç‰‡å£ */
        .slot { position:absolute; top:100px; left:50%; transform:translateX(-50%); width:200px; height:10px; background:#000; z-index:1; border-radius: 5px; }
        
        /* åŠ¨ç”» */
        .ejecting { animation: eject 1s cubic-bezier(0.2,0.8,0.2,1) forwards; }
        @keyframes eject { 0%{transform:translateY(0)} 100%{transform:translateY(-240px) rotate(-3deg)} }

        /* ç­¾åæ¨¡æ€æ¡† */
        #sign-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; }
        
        /* Toast */
        .toast { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); padding:8px 16px; border-radius:20px; opacity:0; transition:0.3s; pointer-events:none; z-index:500; font-size:12px; }
    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨é®ç½© (æ ¸å¿ƒéƒ¨åˆ†) -->
    <div id="mask">
        <h2 style="color:white; letter-spacing:4px; margin-bottom: 10px;">RETRO CAM</h2>
        <div style="color:#888; font-size: 12px;">ULTIMATE EDITION</div>
        
        <button class="start-btn" id="start-btn" onclick="initSystem()">å¯åŠ¨ç›¸æœº / START</button>
        
        <div class="error-box" id="error-box">
            <span class="error-title" id="err-title">å¯åŠ¨å¤±è´¥</span>
            <div class="error-desc" id="err-desc"></div>
        </div>
        <div class="album-hint" id="album-hint">â–¼ å·²è‡ªåŠ¨åˆ‡æ¢è‡³ç›¸å†Œæ¨¡å¼ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹å¼€å¯ â–¼</div>
    </div>

    <div class="toast" id="toast"></div>
    <div id="desk"></div>
    <canvas id="cvs" style="display:none"></canvas>

    <!-- 2. ç›¸æœº UI -->
    <div id="cam-root">
        <div id="f-tip">NORMAL</div>
        <div class="slot" id="slot-ref"></div>

        <div class="body">
            <div class="lens">
                <div class="ring">
                    <div class="glass" onclick="nextFilter()">
                        <video id="video" autoplay playsinline muted></video>
                        <img id="static-img" class="preview-img" style="display:none">
                        <div class="coating"></div>
                    </div>
                </div>
            </div>
            
            <div class="shutter" id="shutter-btn"><span></span></div>
            <div class="viewfinder" id="led"></div>
            <div class="skin"></div>

            <div class="ctrls">
                <div class="btn" onclick="fileInput.click()">ğŸ“‚</div>
                <div class="btn" id="btn-timer" onclick="toggleTimer()">â±ï¸</div>
                <div class="btn" onclick="switchCam()">â†»</div>
                <div class="btn" onclick="saveDesk()">ğŸ’¾</div>
            </div>
        </div>
    </div>

    <!-- 3. ç­¾åæ¨¡æ€æ¡† -->
    <div id="sign-modal">
        <h3 style="color:#fff;">ç­¾å / SIGNATURE</h3>
        <canvas id="pad" width="300" height="150" style="background:#fff; border-radius:4px; border: 2px dashed #666;"></canvas>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn" onclick="document.getElementById('sign-modal').style.display='none'">âŒ</button>
            <button class="btn" onclick="saveSign()" style="color:#4cd137; border-color:#4cd137">âœ”</button>
        </div>
    </div>

    <input type="file" id="file-input" hidden accept="image/*">

    <script>
        // --- å˜é‡å®šä¹‰ ---
        const video = document.getElementById('video');
        const staticImg = document.getElementById('static-img');
        const desk = document.getElementById('desk');
        const cvs = document.getElementById('cvs');
        const slot = document.getElementById('slot-ref');
        
        let stream = null;
        let isFront = true;
        let timerOn = false;
        let useStatic = false;

        const FILTERS = [
            {n:"NORMAL", c:"none"},
            {n:"VIVID", c:"saturate(1.4) contrast(1.1)"},
            {n:"B&W", c:"grayscale(100%) contrast(1.2)"},
            {n:"FILM", c:"sepia(0.3) saturate(1.2) contrast(0.9)"},
            {n:"CYBER", c:"hue-rotate(190deg) saturate(1.2)"}
        ];
        let fIdx = 0;

        // --- 1. æ ¸å¿ƒå¯åŠ¨é€»è¾‘ (æœ€å®½å®¹æ¨¡å¼) ---
        async function initSystem() {
            const btn = document.getElementById('start-btn');
            const errBox = document.getElementById('error-box');
            const albumHint = document.getElementById('album-hint');
            
            btn.innerText = "æ­£åœ¨å¯åŠ¨...";
            
            try {
                // ä»…è¯·æ±‚ videoï¼Œä¸é™åˆ¶åˆ†è¾¨ç‡ï¼Œå…¼å®¹æ€§æœ€å¼º
                const constraints = {
                    video: { facingMode: isFront ? "user" : "environment" },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                // å¿…é¡»ç­‰å¾…å…ƒæ•°æ®åŠ è½½ï¼Œå¦åˆ™é»‘å±
                video.onloadedmetadata = () => {
                    video.play();
                    useStatic = false;
                    video.style.display = 'block';
                    staticImg.style.display = 'none';
                    // æ¸éšé®ç½©
                    document.getElementById('mask').style.opacity = 0;
                    setTimeout(()=>document.getElementById('mask').style.display='none', 500);
                };

            } catch(e) {
                console.error(e);
                errBox.style.display = 'block';
                
                let title = e.name;
                let desc = "è¯·å°è¯•ä½¿ç”¨ç›¸å†Œæ¨¡å¼";

                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    desc = "æ‚¨æ‹’ç»äº†æ‘„åƒå¤´æƒé™ã€‚è¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ çš„å°é”å›¾æ ‡å¼€å¯ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ç›¸å†Œã€‚";
                } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    title = "HTTPS Required";
                    desc = "å½“å‰é“¾æ¥ä¸å®‰å…¨ï¼Œæµè§ˆå™¨ç¦æ­¢è°ƒç”¨ç›¸æœºã€‚è¯·ä½¿ç”¨ Vercel/Netlify éƒ¨ç½²ã€‚";
                }

                document.getElementById('err-title').innerText = title;
                document.getElementById('err-desc').innerText = desc;
                
                // æ”¹å˜æŒ‰é’®ä¸ºç›¸å†Œæ¨¡å¼
                btn.style.display = 'none';
                albumHint.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨æ‰“å¼€ç›¸å†Œ
                setTimeout(() => {
                    document.getElementById('mask').style.display='none';
                    showToast("å·²åˆ‡æ¢è‡³ç›¸å†Œæ¨¡å¼");
                    fileInput.click();
                }, 2500);
            }
        }

        function switchCam() { 
            if(useStatic) return; // ç›¸å†Œæ¨¡å¼ä¸‹ä¸èƒ½ç¿»è½¬
            isFront=!isFront; 
            // å¦‚æœå·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢æ—§æµ
            if(stream) stream.getTracks().forEach(t=>t.stop());
            initSystem(); 
        }

        // --- 2. æ»¤é•œç³»ç»Ÿ ---
        function nextFilter() {
            fIdx = (fIdx+1)%FILTERS.length;
            const css = FILTERS[fIdx].c;
            video.style.filter = css;
            staticImg.style.filter = css;
            
            const tip = document.getElementById('f-tip');
            tip.innerText = FILTERS[fIdx].n; tip.style.opacity=1;
            setTimeout(()=>tip.style.opacity=0, 1000);
        }

        // --- 3. æ‹ç…§ç³»ç»Ÿ ---
        function toggleTimer() {
            timerOn = !timerOn;
            document.getElementById('btn-timer').classList.toggle('active', timerOn);
            showToast(timerOn ? "å€’è®¡æ—¶: 3s" : "å€’è®¡æ—¶: å…³");
        }

        document.getElementById('shutter-btn').addEventListener('click', () => {
            // æŒ‰é’®åŠ¨ç”»
            const s = document.querySelector('.shutter span');
            s.style.transform = 'scale(0.8)';
            setTimeout(()=>s.style.transform='scale(1)', 100);

            if(timerOn) {
                let c = 3;
                const led = document.getElementById('led');
                led.innerText = c;
                const t = setInterval(()=>{
                    c--;
                    if(c>0) led.innerText=c;
                    else { clearInterval(t); led.innerText=""; snap(); }
                }, 1000);
            } else {
                snap();
            }
        });

        async function snap() {
            // é—ªå…‰ç™½å±
            const f=document.createElement('div');
            f.style.cssText="position:fixed;inset:0;background:#fff;z-index:999;transition:0.1s";
            document.body.appendChild(f);
            setTimeout(()=>f.style.opacity=0,50);
            setTimeout(()=>f.remove(),200);

            const url = await render();
            eject(url);
        }

        function render() {
            return new Promise(resolve => {
                const ctx = cvs.getContext('2d');
                cvs.width=600; cvs.height=720;
                
                // 1. åº•çº¸
                ctx.fillStyle="#fff"; ctx.fillRect(0,0,600,720);
                // 2. é»‘è‰²åŒºåŸŸ
                ctx.fillStyle="#101010"; ctx.fillRect(35,35,530,530);

                const src = useStatic ? staticImg : video;
                
                // è·å–æºå°ºå¯¸
                let vw = useStatic ? src.naturalWidth : src.videoWidth;
                let vh = useStatic ? src.naturalHeight : src.videoHeight;
                
                if(!vw || !vh) {
                     // å®¹é”™ï¼šå¦‚æœæ²¡ç”»é¢ï¼Œç”»ä¸ªç°åº•
                    ctx.fillStyle="#333"; ctx.fillRect(35,35,530,530);
                } else {
                    const s = Math.min(vw,vh);
                    const sx=(vw-s)/2, sy=(vh-s)/2;
                    
                    ctx.save();
                    ctx.filter = FILTERS[fIdx].c;
                    
                    if(!useStatic && isFront) {
                        // å‰ç½®æ‘„åƒå¤´éœ€è¦é•œåƒ
                        ctx.translate(565,35); ctx.scale(-1,1);
                        ctx.drawImage(src, sx,sy,s,s,0,0,530,530);
                    } else {
                        ctx.drawImage(src, sx,sy,s,s,35,35,530,530);
                    }
                    ctx.restore();
                }
                
                // 3. åŠ ä¸Šæ—¥æœŸæ°´å°
                const date = new Date();
                const dStr = `${date.getFullYear().toString().slice(2)} ${date.getMonth()+1} ${date.getDate()}`;
                ctx.font = "20px monospace";
                ctx.fillStyle = "rgba(255, 165, 0, 0.7)";
                ctx.fillText(dStr, 480, 600);

                resolve(cvs.toDataURL('image/jpeg', 0.85));
            });
        }

        // --- 4. åç‰‡ä¸æ‹–æ‹½ ---
        function eject(url) {
            const id = Date.now();
            const card = document.createElement('div');
            card.className = 'card';
            const r = slot.getBoundingClientRect();
            // å±…ä¸­
            card.style.left = (window.innerWidth/2 - 80) + 'px';
            card.style.top = r.top + 'px';
            
            card.innerHTML = `<img src="${url}"><canvas id="sig-${id}"></canvas>`;
            desk.appendChild(card);
            
            requestAnimationFrame(()=>card.classList.add('ejecting'));
            initDrag(card, id, url);
        }

        function initDrag(el, id, url) {
            let z=100, moved=false;
            const start=e=>{
                moved=false; el.style.zIndex=++z;
                const t=e.touches?e.touches[0]:e;
                const r=el.getBoundingClientRect();
                const ox=t.clientX-r.left, oy=t.clientY-r.top;
                
                const move=ev=>{
                    moved=true; ev.preventDefault();
                    const tc=ev.touches?ev.touches[0]:ev;
                    el.style.left=(tc.clientX-ox)+'px'; el.style.top=(tc.clientY-oy)+'px';
                    el.classList.remove('ejecting');
                }
                const end=()=>{
                    window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',end);
                    window.removeEventListener('touchmove',move); window.removeEventListener('touchend',end);
                    if(!moved) showMenu(id, url);
                }
                window.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
                window.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',end);
            };
            el.addEventListener('mousedown',start); el.addEventListener('touchstart',start,{passive:false});
        }

        function showMenu(id, url) {
            // ç®€å•çš„åŸç”Ÿå¼¹çª—èœå•
            if(confirm("ä½ è¦åšä»€ä¹ˆï¼Ÿ\n\n[ç¡®å®š] = âœï¸ ç­¾å\n[å–æ¶ˆ] = â¬‡ ä¿å­˜ç…§ç‰‡")) {
                openSign(id);
            } else {
                const a=document.createElement('a'); a.href=url; a.download=`instax_${id}.jpg`; a.click();
            }
        }

        // --- 5. ç­¾å ---
        let curSig = null;
        const pad = document.getElementById('pad');
        const pCtx = pad.getContext('2d');
        pCtx.strokeStyle="#333"; pCtx.lineWidth=3; pCtx.lineCap="round";
        let painting=false;
        
        function openSign(id) {
            curSig=id; document.getElementById('sign-modal').style.display='flex';
            pCtx.clearRect(0,0,300,150);
        }
        function saveSign() {
            if(curSig) {
                const c=document.getElementById(`sig-${curSig}`);
                const cx=c.getContext('2d');
                c.width=140; c.height=35;
                cx.drawImage(pad,0,0,300,150,0,0,140,35);
            }
            document.getElementById('sign-modal').style.display='none';
        }
        
        const getP=e=>{const r=pad.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}};
        ['mousedown','touchstart'].forEach(k=>pad.addEventListener(k,e=>{painting=true;e.preventDefault();const p=getP(e);pCtx.beginPath();pCtx.moveTo(p.x,p.y)}));
        ['mousemove','touchmove'].forEach(k=>pad.addEventListener(k,e=>{if(painting){e.preventDefault();const p=getP(e);pCtx.lineTo(p.x,p.y);pCtx.stroke()}}));
        ['mouseup','touchend'].forEach(k=>pad.addEventListener(k,()=>painting=false));

        // --- 6. ç›¸å†Œä¸ä¿å­˜æ¡Œé¢ ---
        document.getElementById('file-input').addEventListener('change', e=>{
            if(e.target.files[0]) {
                const u = URL.createObjectURL(e.target.files[0]);
                staticImg.src = u;
                staticImg.onload = () => {
                    useStatic = true;
                    video.style.display = 'none';
                    staticImg.style.display = 'block';
                    document.getElementById('mask').style.display='none';
                };
            }
        });

        async function saveDesk() {
            showToast("æ­£åœ¨ä¿å­˜æ¡Œé¢...");
            const dc=document.createElement('canvas');
            dc.width=window.innerWidth; dc.height=window.innerHeight;
            const c=dc.getContext('2d');
            c.fillStyle="#2b2b2b"; c.fillRect(0,0,dc.width,dc.height);
            document.querySelectorAll('.card').forEach(el=>{
                const r=el.getBoundingClientRect();
                const img=el.querySelector('img');
                const sig=el.querySelector('canvas');
                c.save(); c.translate(r.left+r.width/2, r.top+r.height/2);
                c.fillStyle="#fff"; c.fillRect(-80,-110,160,190);
                if(img) c.drawImage(img,-70,-100,140,140);
                if(sig) c.drawImage(sig,-70,50,140,35);
                c.restore();
            });
            const a=document.createElement('a'); a.href=dc.toDataURL(); a.download='my_desktop.jpg'; a.click();
        }

        function showToast(m) {
            const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1;
            setTimeout(()=>t.style.opacity=0, 2000);
        }
    </script>
</body>
</html>