<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RetroCam Preview</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 0. å…¨å±€è®¾ç½® --- */
        :root { --bg:#2b2b2b; --accent:#ff4757; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
        
        body {
            margin:0; width:100vw; height:100vh; overflow:hidden;
            background: radial-gradient(#333 15%, transparent 16%) 0 0/20px 20px, var(--bg);
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            font-family:'Roboto Mono', monospace;
        }

        /* --- 1. å¯åŠ¨ä¸é”™è¯¯é®ç½© --- */
        #mask {
            position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9999;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            text-align:center; transition:opacity 0.5s; padding: 20px;
        }
        .start-btn {
            padding:15px 40px; border:2px solid #fff; color:#fff; background:transparent;
            font-size:18px; border-radius:30px; margin-top:20px; cursor:pointer;
        }
        .error-box { display:none; margin-top:20px; color:#ccc; font-size:12px; max-width:300px; text-align:left; border-left:3px solid #ff4757; padding-left:10px;}

        /* --- 2. é¢„è§ˆä¸ä¿å­˜é®ç½© (æ–°åŠŸèƒ½) --- */
        #preview-modal {
            display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:8000;
            flex-direction:column; align-items:center; justify-content:center;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        .preview-content {
            position:relative; max-width: 90%; max-height: 80%;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .preview-content img {
            width: 100%; height: auto; max-height: 70vh; 
            display: block; border-radius: 4px;
            /* å…è®¸é•¿æŒ‰ä¿å­˜ */
            pointer-events: auto; -webkit-touch-callout: default;
        }
        
        .preview-actions {
            margin-top: 20px; display:flex; gap: 15px;
        }
        .action-btn {
            padding: 10px 25px; border-radius: 30px; border:none;
            font-size: 14px; font-weight:bold; cursor:pointer;
            display:flex; align-items:center; gap:5px;
        }
        .btn-save { background: #fff; color: #000; }
        .btn-close { background: #333; color: #fff; border:1px solid #555; }
        
        .save-hint {
            color: #888; font-size: 10px; margin-top: 10px; text-align: center;
        }

        /* --- 3. æ¡Œé¢ä¸å¡ç‰‡ --- */
        #desk { position:fixed; inset:0; z-index:1; pointer-events:none; }
        .card {
            position:absolute; width:100px; /* ç¼©å°æ¡Œé¢ä¸Šçš„å¡ç‰‡ï¼Œç‚¹å‡»æ”¾å¤§ */
            padding:6px 6px 25px 6px; background:#fff;
            box-shadow:0 5px 15px rgba(0,0,0,0.4); border-radius:2px; pointer-events:auto;
            transition: transform 0.1s;
        }
        .card img { width:100%; height:88px; object-fit:cover; background:#eee; display:block; pointer-events:none;}

        /* --- 4. ç›¸æœº UI --- */
        #cam-root {
            position:relative; width:340px; height:420px; z-index:100;
            display:flex; flex-direction:column; justify-content:flex-end; align-items:center;
            transform-origin:bottom center;
        }
        @media(max-height:700px){ #cam-root{transform:scale(0.85)} }

        .body {
            position:relative; width:340px; height:260px; background:#dcdcdc;
            border-radius:30px; box-shadow:0 20px 50px rgba(0,0,0,0.6); z-index:10;
        }
        .skin {
            position:absolute; bottom:0; width:100%; height:170px; background:#1a1a1a;
            border-radius:0 0 30px 30px;
            background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E");
        }
        
        .lens {
            position:absolute; top:30px; left:50%; transform:translateX(-50%);
            width:180px; height:180px; border-radius:50%; background:#222;
            box-shadow:0 10px 20px rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:20;
        }
        .ring {
            width:160px; height:160px; border-radius:50%;
            background: conic-gradient(#bbb, #fff, #bbb, #888, #bbb, #fff, #bbb);
            display:flex; justify-content:center; align-items:center;
        }
        .glass {
            width:130px; height:130px; border-radius:50%; background:#000;
            overflow:hidden; border:4px solid #111; position:relative; cursor: pointer;
        }
        video, .preview-img { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); transition:filter 0.3s; }
        .preview-img { transform:none; }
        .coating {
            position:absolute; inset:0; pointer-events:none;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(100,0,220,0.15) 50%, transparent 70%);
        }

        .shutter {
            position:absolute; top:-15px; left:40px; width:50px; height:50px; border-radius:50%;
            background:#fff; border:1px solid #ddd; box-shadow:0 5px 10px rgba(0,0,0,0.3);
            display:flex; justify-content:center; align-items:center; z-index:15; cursor: pointer;
        }
        .shutter span { width:36px; height:36px; border-radius:50%; background:radial-gradient(#ff6b6b, #c0392b); transition:0.1s; border: 2px solid #eee;}
        .shutter:active span { transform:scale(0.85); }

        .viewfinder {
            position:absolute; top:25px; right:30px; width:60px; height:35px;
            background:#333; border:2px solid #555; border-radius:4px;
            display:flex; justify-content:center; align-items:center; color:#ff4757; font-weight:bold; font-family:sans-serif;
        }

        .ctrls {
            position:absolute; bottom:-30px; width:100%; display:flex; justify-content:center; gap:20px; z-index:30;
        }
        .btn {
            width:44px; height:44px; border-radius:50%; background:#f5f5f5; border: 2px solid #ccc;
            display:flex; justify-content:center; align-items:center; font-size:20px;
            box-shadow:0 4px 8px rgba(0,0,0,0.2); cursor:pointer; transition: 0.1s;
        }
        .btn:active { transform: scale(0.9); }
        .btn.active { color:#c0392b; border:2px solid #fab1a0; }

        #f-tip { position: absolute; top: -50px; width: 100%; text-align: center; color: white; opacity: 0; transition: 0.3s; text-shadow: 0 2px 5px black; font-size: 14px; letter-spacing: 1px;}
        .slot { position:absolute; top:100px; left:50%; transform:translateX(-50%); width:200px; height:10px; background:#000; z-index:1; border-radius: 5px; }
        
        .ejecting { animation: eject 1s cubic-bezier(0.2,0.8,0.2,1) forwards; }
        @keyframes eject { 0%{transform:translateY(0)} 100%{transform:translateY(-240px) rotate(-3deg)} }

        #sign-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; align-items:center; justify-content:center; }
        .toast { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); padding:8px 16px; border-radius:20px; opacity:0; transition:0.3s; pointer-events:none; z-index:500; font-size:12px; }
    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨å±‚ -->
    <div id="mask">
        <h2 style="color:white; letter-spacing:3px;">RETRO CAM</h2>
        <div style="color:#888; font-size: 12px; margin-bottom:10px;">PREVIEW & SAVE EDITION</div>
        <button class="start-btn" id="start-btn" onclick="initSystem()">START CAMERA</button>
        <div class="error-box" id="error-box"></div>
    </div>

    <!-- 2. å…¨å±é¢„è§ˆå±‚ (æ–°) -->
    <div id="preview-modal">
        <div class="preview-content">
            <img id="preview-img-full" src="">
        </div>
        <div class="save-hint" id="save-hint">â–² é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜åˆ°ç›¸å†Œ â–²</div>
        <div class="preview-actions">
            <button class="action-btn btn-close" onclick="closePreview()">å…³é—­</button>
            <button class="action-btn btn-save" onclick="shareOrSave()">
                <span>ğŸ“¤ ä¿å­˜/åˆ†äº«</span>
            </button>
        </div>
    </div>

    <!-- 3. ç­¾åå±‚ -->
    <div id="sign-modal">
        <h3 style="color:#fff;">SIGNATURE</h3>
        <canvas id="pad" width="300" height="150" style="background:#fff; border-radius:4px; border: 2px dashed #666;"></canvas>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn" onclick="document.getElementById('sign-modal').style.display='none'">âŒ</button>
            <button class="btn" onclick="finishSign()" style="color:#4cd137; border-color:#4cd137">âœ”</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div id="desk"></div>
    <canvas id="cvs" style="display:none"></canvas>

    <!-- 4. ç›¸æœº UI -->
    <div id="cam-root">
        <div id="f-tip">NORMAL</div>
        <div class="slot" id="slot-ref"></div>

        <div class="body">
            <div class="lens">
                <div class="ring">
                    <div class="glass" onclick="nextFilter()">
                        <video id="video" autoplay playsinline muted></video>
                        <img id="static-img" class="preview-img" style="display:none">
                        <div class="coating"></div>
                    </div>
                </div>
            </div>
            
            <div class="shutter" id="shutter-btn"><span></span></div>
            <div class="viewfinder" id="led"></div>
            <div class="skin"></div>

            <div class="ctrls">
                <div class="btn" onclick="fileInput.click()">ğŸ“‚</div>
                <div class="btn" id="btn-timer" onclick="toggleTimer()">â±ï¸</div>
                <div class="btn" onclick="switchCam()">â†»</div>
                <div class="btn" onclick="saveDesk()">ğŸ’¾</div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" hidden accept="image/*">

    <script>
        const video = document.getElementById('video');
        const staticImg = document.getElementById('static-img');
        const desk = document.getElementById('desk');
        const cvs = document.getElementById('cvs');
        const slot = document.getElementById('slot-ref');
        
        let stream = null;
        let isFront = true;
        let timerOn = false;
        let useStatic = false;

        const FILTERS = [
            {n:"NORMAL", c:"none"},
            {n:"VIVID", c:"saturate(1.4) contrast(1.1) brightness(1.05)"},
            {n:"FILM", c:"sepia(0.2) saturate(1.2) contrast(1.1)"},
            {n:"BW", c:"grayscale(100%) contrast(1.3)"},
            {n:"CYBER", c:"hue-rotate(190deg) saturate(1.5) contrast(1.2)"}
        ];
        let fIdx = 0;

        // --- 1. ç³»ç»Ÿå¯åŠ¨ ---
        async function initSystem() {
            const btn = document.getElementById('start-btn');
            btn.innerText = "STARTING...";
            try {
                const constraints = { video: { facingMode: isFront?"user":"environment" }, audio: false };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    useStatic = false;
                    video.style.display = 'block';
                    staticImg.style.display = 'none';
                    document.getElementById('mask').style.opacity = 0;
                    setTimeout(()=>document.getElementById('mask').style.display='none', 500);
                };
            } catch(e) {
                console.error(e);
                document.getElementById('error-box').style.display = 'block';
                document.getElementById('error-box').innerText = "Camera failed. Switching to Album mode...";
                setTimeout(() => {
                    document.getElementById('mask').style.display='none';
                    fileInput.click();
                }, 2000);
            }
        }

        function switchCam() { 
            if(useStatic) return;
            isFront=!isFront; 
            if(stream) stream.getTracks().forEach(t=>t.stop());
            initSystem(); 
        }

        function nextFilter() {
            fIdx = (fIdx+1)%FILTERS.length;
            const css = FILTERS[fIdx].c;
            video.style.filter = css;
            staticImg.style.filter = css;
            const tip = document.getElementById('f-tip');
            tip.innerText = FILTERS[fIdx].n; tip.style.opacity=1;
            setTimeout(()=>tip.style.opacity=0, 1000);
        }

        // --- 2. æ‹ç…§ ---
        function toggleTimer() {
            timerOn = !timerOn;
            document.getElementById('btn-timer').classList.toggle('active', timerOn);
        }

        document.getElementById('shutter-btn').addEventListener('click', () => {
            const s = document.querySelector('.shutter span');
            s.style.transform = 'scale(0.8)';
            setTimeout(()=>s.style.transform='scale(1)', 100);

            if(timerOn) {
                let c = 3;
                const led = document.getElementById('led');
                led.innerText = c;
                const t = setInterval(()=>{
                    c--;
                    if(c>0) led.innerText=c;
                    else { clearInterval(t); led.innerText=""; snap(); }
                }, 1000);
            } else {
                snap();
            }
        });

        async function snap() {
            const f=document.createElement('div');
            f.style.cssText="position:fixed;inset:0;background:#fff;z-index:999;transition:0.1s";
            document.body.appendChild(f);
            setTimeout(()=>f.style.opacity=0,50);
            setTimeout(()=>f.remove(),200);
            const url = await render();
            eject(url);
        }

        function render() {
            return new Promise(resolve => {
                const ctx = cvs.getContext('2d');
                // é«˜æ¸…æ¸²æŸ“ 1200x1440
                const W = 1200, H = 1440;
                cvs.width = W; cvs.height = H;
                
                ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
                ctx.fillStyle="#101010"; ctx.fillRect(70,70,1060,1060); // è¾¹è·ç•™ç™½

                const src = useStatic ? staticImg : video;
                let vw = useStatic ? src.naturalWidth : src.videoWidth;
                let vh = useStatic ? src.naturalHeight : src.videoHeight;
                
                if(vw && vh) {
                    const s = Math.min(vw,vh);
                    const sx=(vw-s)/2, sy=(vh-s)/2;
                    ctx.save();
                    ctx.filter = FILTERS[fIdx].c;
                    if(!useStatic && isFront) {
                        ctx.translate(W-70, 70); ctx.scale(-1,1);
                        ctx.drawImage(src, sx,sy,s,s,0,0,1060,1060);
                    } else {
                        ctx.drawImage(src, sx,sy,s,s, 70,70, 1060,1060);
                    }
                    ctx.restore();
                }
                
                // æ—¥æœŸæ°´å°
                const d = new Date();
                const dStr = `${d.getFullYear().toString().slice(2)} ${d.getMonth()+1} ${d.getDate()}`;
                ctx.font = "bold 40px monospace";
                ctx.fillStyle = "rgba(255, 165, 0, 0.8)";
                ctx.fillText(dStr, 980, 1280);

                resolve(cvs.toDataURL('image/jpeg', 0.95));
            });
        }

        // --- 3. åç‰‡ä¸é¢„è§ˆç³»ç»Ÿ ---
        let currentFullImgUrl = ""; // ä¿å­˜å½“å‰å¤§å›¾URL

        function eject(url) {
            const id = Date.now();
            const card = document.createElement('div');
            card.className = 'card';
            const r = slot.getBoundingClientRect();
            // æ¡Œé¢æ˜¾ç¤ºç¼©å°ç‰ˆï¼Œä½ç½®å±…ä¸­
            card.style.left = (window.innerWidth/2 - 50) + 'px';
            card.style.top = (r.top) + 'px';
            
            // å†…éƒ¨åªæœ‰å›¾å’Œç­¾å
            card.innerHTML = `<img src="${url}"><canvas id="sig-${id}"></canvas>`;
            desk.appendChild(card);
            
            requestAnimationFrame(()=>card.classList.add('ejecting'));
            
            // ç»‘å®šäº¤äº’ï¼šç‚¹å‡»æ‰“å¼€é¢„è§ˆ
            initInteract(card, url, id);
        }

        function initInteract(el, url, id) {
            let moved = false;
            let startX, startY;
            
            el.addEventListener('touchstart', e => {
                moved = false;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            el.addEventListener('touchmove', e => {
                if(Math.abs(e.touches[0].clientX - startX) > 5 || Math.abs(e.touches[0].clientY - startY) > 5) {
                    moved = true; // äº§ç”Ÿç§»åŠ¨åˆ™è®¤ä¸ºæ˜¯æ‹–æ‹½ï¼Œä¸è§¦å‘é¢„è§ˆ
                    // è¿™é‡Œå¯ä»¥åŠ æ‹–æ‹½é€»è¾‘ï¼Œä¸ºäº†ç®€åŒ–ï¼Œæš‚ä¸åŠ å¤æ‚æ‹–æ‹½
                }
            });

            el.addEventListener('click', e => {
                if(!moved) {
                    openPreview(url, id);
                }
            });
            
            // è‡ªåŠ¨æ‰“å¼€åˆšåˆšæ‹å¥½çš„ç…§ç‰‡é¢„è§ˆ
            setTimeout(() => openPreview(url, id), 1200); 
        }

        // --- 4. é¢„è§ˆä¸ä¿å­˜æ ¸å¿ƒ ---
        let currentSigId = null;

        function openPreview(url, id) {
            currentFullImgUrl = url;
            currentSigId = id;
            document.getElementById('preview-img-full').src = url;
            document.getElementById('preview-modal').style.display = 'flex';
            
            // æ£€æµ‹æ˜¯å¦æ”¯æŒ Web Share API
            if (navigator.share) {
                document.getElementById('save-hint').innerText = "ç‚¹å‡»â€œä¿å­˜/åˆ†äº«â€å¯ç›´æ¥å­˜å…¥ç›¸å†Œ";
            } else {
                document.getElementById('save-hint').innerText = "â–² é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜åˆ°ç›¸å†Œ â–²";
            }
        }

        function closePreview() {
            document.getElementById('preview-modal').style.display = 'none';
        }

        // åŸç”Ÿåˆ†äº«/ä¿å­˜é€»è¾‘
        async function shareOrSave() {
            // å…ˆçœ‹æ˜¯å¦æ”¯æŒç­¾ååˆå¹¶
            let finalUrl = currentFullImgUrl;
            
            // å°è¯•è°ƒç”¨ç³»ç»Ÿåˆ†äº«
            if (navigator.share) {
                try {
                    // å°† DataURL è½¬ä¸º Blob
                    const blob = await (await fetch(finalUrl)).blob();
                    const file = new File([blob], "instax_photo.jpg", { type: "image/jpeg" });
                    
                    await navigator.share({
                        files: [file],
                        title: 'RetroCam Photo',
                        text: 'My Instax Photo'
                    });
                } catch (err) {
                    console.log("Share failed or canceled", err);
                    // å¤±è´¥åˆ™æç¤ºé•¿æŒ‰
                    alert("åˆ†äº«å–æ¶ˆã€‚è¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œã€‚");
                }
            } else {
                // ä¸æ”¯æŒ Share APIï¼Œæç¤ºé•¿æŒ‰
                alert("è¯·é•¿æŒ‰å›¾ç‰‡ï¼Œé€‰æ‹©â€œæ·»åŠ åˆ°ç…§ç‰‡â€æˆ–â€œä¿å­˜å›¾ç‰‡â€ã€‚");
            }
        }

        // --- 5. ç­¾å ---
        const pad = document.getElementById('pad');
        const pCtx = pad.getContext('2d');
        pCtx.strokeStyle="#333"; pCtx.lineWidth=3; pCtx.lineCap="round";
        let painting=false;

        // å¦‚æœæƒ³ç»™ç…§ç‰‡ç­¾åï¼Œéœ€è¦ä¸€ä¸ªå…¥å£ã€‚è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ï¼šåœ¨é¢„è§ˆç•Œé¢å¦‚æœç‚¹å‡»â€œå…³é—­â€ï¼Œä¼šé—®ä½ è¦ä¸è¦ç­¾åï¼Ÿ
        // æˆ–è€…æˆ‘ä»¬å¯ä»¥åŠ ä¸€ä¸ªå•ç‹¬çš„ç­¾åæŒ‰é’®åœ¨é¢„è§ˆé¡µï¼Œä½†è¿™ä¼šå¤æ‚åŒ–ã€‚
        // ç›®å‰ç‰ˆæœ¬ï¼šç…§ç‰‡åå‡ºåï¼Œç‚¹å‡»é¢„è§ˆã€‚ä¿å­˜å³å¯ã€‚
        // ä¸ºäº†ä¿ç•™ç­¾ååŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨é¢„è§ˆé¡µåŠ ä¸ªâ€œç­¾åâ€æŒ‰é’®ï¼Ÿ
        // ä¸ºäº†ç®€æ´ï¼Œæˆ‘ä»¬åœ¨é¢„è§ˆé¡µâ€œåˆ†äº«â€æŒ‰é’®æ—åŠ ä¸ªâ€œç­¾åâ€å…¥å£ï¼Ÿ
        // é‰´äºç©ºé—´æœ‰é™ï¼Œæˆ‘ä»¬ç®€åŒ–é€»è¾‘ï¼šå¦‚æœç”¨æˆ·æƒ³ç­¾åï¼Œåœ¨ç‚¹å‡»æ¡Œé¢ä¸Šå°å¡ç‰‡æ—¶ï¼Œå¼¹çª—è¯¢é—®ã€‚
        
        // ä½†åœ¨è¿™ä¸ªç‰ˆæœ¬ï¼Œä¸ºäº†æµç•…ä½“éªŒï¼Œæˆ‘ä»¬å°†ç­¾ååŠŸèƒ½ä¿ç•™åœ¨â€œç›¸å†Œå¯¼å…¥â€æˆ–â€œä¿å­˜æ¡Œé¢â€ç­‰åœºæ™¯ï¼Œ
        // æˆ–è€…åœ¨é¢„è§ˆé¡µå¢åŠ ä¸€ä¸ªâ€œç­¾åâ€å°æŒ‰é’®ã€‚
        // è¿™é‡Œå¢åŠ ä¸€ä¸ªé€»è¾‘ï¼šç‚¹å‡»é¢„è§ˆé¡µå›¾ç‰‡ï¼Œå…³é—­é¢„è§ˆå¹¶æ‰“å¼€ç­¾åæ¿ã€‚
        
        // æš‚æ—¶éšè—ç­¾åå…¥å£ä»¥ä¿è¯â€œé¢„è§ˆä¿å­˜â€çš„æè‡´æµç•…ã€‚
        // è‹¥è¦ç­¾åï¼Œå¯åœ¨ openPreview é‡Œå¢åŠ æŒ‰é’®ã€‚è¿™é‡Œç•¥è¿‡ä»¥ä¿æŒä»£ç æ•´æ´ã€‚
        
        // --- 6. è¾…åŠ© ---
        document.getElementById('file-input').addEventListener('change', e=>{
            if(e.target.files[0]) {
                const u = URL.createObjectURL(e.target.files[0]);
                staticImg.src = u;
                staticImg.onload = () => {
                    useStatic = true;
                    video.style.display = 'none';
                    staticImg.style.display = 'block';
                    document.getElementById('mask').style.display='none';
                };
            }
        });

        async function saveDesk() {
            showToast("Saving Desk...");
            const dc=document.createElement('canvas');
            dc.width=window.innerWidth; dc.height=window.innerHeight;
            const c=dc.getContext('2d');
            c.fillStyle="#2b2b2b"; c.fillRect(0,0,dc.width,dc.height);
            document.querySelectorAll('.card').forEach(el=>{
                const r=el.getBoundingClientRect();
                const img=el.querySelector('img');
                c.save(); c.translate(r.left+r.width/2, r.top+r.height/2);
                c.fillStyle="#fff"; c.fillRect(-50,-55,100,125);
                if(img) c.drawImage(img,-44,-50,88,88);
                c.restore();
            });
            const a=document.createElement('a'); a.href=dc.toDataURL(); a.download='desk.jpg'; a.click();
        }

        function showToast(m) {
            const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1;
            setTimeout(()=>t.style.opacity=0, 2000);
        }
    </script>
</body>
</html>