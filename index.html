<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vintage Polaroid</title>
    <!-- å¼•å…¥æ‰“å­—æœºå­—ä½“å’Œæ‰‹å†™ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Cedarville+Cursive&display=swap" rel="stylesheet">
    <style>
        :root {
            --leather-dark: #1a1a1a;
            --metal-silver: #d1d1d1;
            --metal-dark: #444;
            --shutter-accent: #b71c1c;
            --paper-texture: #fdfbf7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: #2c2c2c;
            /* æœ¨çº¹æ¡Œé¢èƒŒæ™¯ */
            background-image: repeating-linear-gradient(45deg, #2b2b2b 0px, #2b2b2b 2px, #262626 2px, #262626 4px);
            overflow: hidden;
            font-family: 'Special Elite', monospace;
            touch-action: none;
        }

        /* --- 1. ç…§ç‰‡å¢™ --- */
        #photo-wall {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        /* --- 2. æ‹ç«‹å¾—ç…§ç‰‡å®ä½“ --- */
        .polaroid-card {
            position: absolute;
            width: 160px;
            /* è¿™é‡Œä¸è®¾é«˜åº¦ï¼Œç”±å†…å®¹æ’‘å¼€ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šæ˜¯ç”Ÿæˆä¸€å¼ æ•´å›¾ */
            z-index: 10;
            cursor: grab;
            transition: transform 0.1s;
            /* å…³é”®ï¼šé˜´å½±è®©å®ƒçœ‹èµ·æ¥æµ®åœ¨æ¡Œé¢ä¸Š */
            filter: drop-shadow(2px 5px 10px rgba(0,0,0,0.5));
        }

        .polaroid-card:active {
            cursor: grabbing;
            filter: drop-shadow(5px 15px 25px rgba(0,0,0,0.6));
            z-index: 9999 !important;
        }

        /* åˆæˆåçš„å›¾ç‰‡æ ·å¼ */
        .polaroid-img {
            width: 100%;
            display: block;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€ç»™çˆ¶çº§divç”¨äºæ‹–æ‹½ */
        }

        /* ä¸‹è½½/ä¿å­˜æŒ‰é’® (æ‚¬æµ®åœ¨ç…§ç‰‡è§’è½) */
        .save-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 20;
            font-size: 14px;
            opacity: 0.5;
        }
        .save-btn:active { background: rgba(0,0,0,0.3); }

        /* åŠ¨ç”»ï¼šå¼¹å‡º */
        .ejecting {
            animation: ejectAnim 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        @keyframes ejectAnim {
            from { transform: translate(-50%, 50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -120%) scale(1) rotate(-3deg); opacity: 1; }
        }

        /* --- 3. å¤å¤ç›¸æœº UI --- */
        .camera-rig {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            height: 260px; /* æœºèº«é«˜åº¦ */
            z-index: 100;
            display: flex;
            justify-content: center;
        }

        /* é»‘è‰²çš®é©æœºèº« */
        .camera-body {
            position: absolute;
            bottom: -20px; /* æ²‰åº•ä¸€ç‚¹ */
            width: 90%;
            height: 240px;
            background: var(--leather-dark);
            border-radius: 20px 20px 0 0;
            box-shadow: 
                0 -5px 20px rgba(0,0,0,0.6),
                inset 0 2px 2px rgba(255,255,255,0.1);
            /* çš®é©çº¹ç†æ¨¡æ‹Ÿ */
            background-image: 
                radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 4px 4px;
            background-position: 0 0, 2px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 4px solid #333;
        }

        /* é‡‘å±é¥°é¢æ¡ */
        .metal-strip {
            position: absolute;
            top: 20px;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, #d1d1d1 0%, #999 50%, #d1d1d1 100%);
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* é•œå¤´ */
        .lens-assembly {
            position: absolute;
            top: 40px;
            width: 140px;
            height: 140px;
            background: #111;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #333;
        }

        .lens-glass {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            background: #000;
            border: 4px solid #222;
        }

        video, .static-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* ç¨å¾®åŠ ç‚¹è€é•œå¤´çš„æ„Ÿè§‰ */
            filter: contrast(1.1) saturate(0.9);
        }
        
        video { transform: scaleX(-1); } /* é»˜è®¤å‰ç½®é•œåƒ */

        /* é•œå¤´åå…‰ */
        .lens-glass::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 40%);
            pointer-events: none;
        }

        /* çº¢è‰²å¿«é—¨æŒ‰é’® */
        .shutter-btn {
            position: absolute;
            right: 20px;
            top: -15px; /* å‡¸å‡ºæœºèº« */
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #ff5252, #b71c1c);
            border: 3px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .shutter-btn:active { transform: translateY(4px); }

        /* åŠŸèƒ½æŒ‰é’® (ç›¸å†Œã€åˆ‡æ¢) */
        .sub-btn {
            width: 40px;
            height: 40px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            bottom: 20px;
            z-index: 15;
            box-shadow: inset 0 0 5px #000;
        }
        .sub-btn:active { background: #222; }

        .btn-album { left: 30px; }
        .btn-switch { right: 30px; }

        /* å‡ºç‰‡å£ç¼éš™ */
        .slot {
            position: absolute;
            top: -5px;
            width: 180px;
            height: 10px;
            background: #000;
            z-index: 5;
            border-radius: 4px;
        }

        /* éšè—input */
        #file-picker { display: none; }

        /* æç¤º */
        .msg-box {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px 25px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
            text-align: center;
            font-size: 14px;
        }

    </style>
</head>
<body>

    <!-- æ¶ˆæ¯æç¤º -->
    <div class="msg-box" id="msg-box">æç¤ºä¿¡æ¯</div>

    <!-- ç…§ç‰‡å¢™ -->
    <div id="photo-wall"></div>

    <!-- éšè—çš„ Canvas ç”¨äºåˆæˆ -->
    <canvas id="composite-canvas" style="display: none;"></canvas>

    <!-- ç›¸æœºä¸»ä½“ -->
    <div class="camera-rig">
        <div class="slot" id="slot-ref"></div>
        
        <div class="camera-body">
            <div class="metal-strip"></div>
            
            <!-- é•œå¤´ -->
            <div class="lens-assembly">
                <div class="lens-glass">
                    <video id="video" autoplay playsinline muted></video>
                    <img id="preview-img" class="static-preview" style="display:none;">
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <input type="file" id="file-picker" accept="image/*">
            <div class="sub-btn btn-album" id="album-btn" title="å¯¼å…¥ç…§ç‰‡">ğŸ“‚</div>
            <div class="sub-btn btn-switch" id="switch-btn" title="åˆ‡æ¢é•œå¤´">â†»</div>
        </div>

        <!-- å¿«é—¨ (ç‹¬ç«‹äºBodyï¼Œä¸ºäº†å±‚çº§å¥½æ§åˆ¶) -->
        <button class="shutter-btn" id="shutter"></button>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        const video = document.getElementById('video');
        const previewImg = document.getElementById('preview-img');
        const canvas = document.getElementById('composite-canvas');
        const photoWall = document.getElementById('photo-wall');
        const msgBox = document.getElementById('msg-box');
        const slotRef = document.getElementById('slot-ref');

        let isFrontCam = true;
        let currentStream = null;
        let useStaticImage = false; // æ˜¯å¦ä½¿ç”¨ç›¸å†Œå›¾ç‰‡

        // --- 1. æ‘„åƒå¤´åˆå§‹åŒ– ---
        async function initCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            const constraints = {
                video: {
                    facingMode: isFrontCam ? 'user' : 'environment',
                    width: { ideal: 1080 },
                    height: { ideal: 1080 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                video.style.display = 'block';
                previewImg.style.display = 'none';
                // é•œåƒé€»è¾‘ï¼šå‰ç½®é•œåƒï¼Œåç½®æ­£å¸¸
                video.style.transform = isFrontCam ? 'scaleX(-1)' : 'scaleX(1)';
                useStaticImage = false;
            } catch (err) {
                console.warn(err);
                showMsg("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨ç›¸å†Œ ğŸ“‚");
            }
        }

        // åˆ‡æ¢é•œå¤´
        document.getElementById('switch-btn').addEventListener('click', () => {
            isFrontCam = !isFrontCam;
            initCamera();
        });

        // å¯åŠ¨
        initCamera();

        // --- 2. ç›¸å†Œå¯¼å…¥ ---
        const filePicker = document.getElementById('file-picker');
        document.getElementById('album-btn').addEventListener('click', () => filePicker.click());

        filePicker.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    previewImg.src = evt.target.result;
                    video.style.display = 'none';
                    previewImg.style.display = 'block';
                    useStaticImage = true;
                    showMsg("ç…§ç‰‡å·²è£…è½½");
                };
                reader.readAsDataURL(file);
            }
        });

        // --- 3. æ‹ç…§åˆæˆé€»è¾‘ (æ ¸å¿ƒ) ---
        document.getElementById('shutter').addEventListener('click', () => {
            // æŒ‰é’®åŠ¨æ•ˆ
            const btn = document.getElementById('shutter');
            btn.style.transform = 'scale(0.9)';
            setTimeout(() => btn.style.transform = '', 100);

            processPhoto();
        });

        function processPhoto() {
            const ctx = canvas.getContext('2d');
            
            // è®¾å®šæ‹ç«‹å¾—çš„é«˜æ¸…å°ºå¯¸ (Canvaså°ºå¯¸)
            // ç»å…¸æ¯”ä¾‹ï¼šå®½åº¦ 8.8cm (è®¾ä¸º600px)ï¼Œé«˜åº¦ 10.7cm (è®¾ä¸º720px)
            const cw = 600;
            const ch = 720;
            canvas.width = cw;
            canvas.height = ch;

            // A. ç»˜åˆ¶ç›¸çº¸åº•è‰² (ç±³ç™½è‰²å¸¦çº¹ç†)
            ctx.fillStyle = '#fdfbf7';
            ctx.fillRect(0, 0, cw, ch);
            
            // æ·»åŠ ä¸€ç‚¹æ‚è‰²æ¨¡æ‹Ÿçº¸å¼ 
            // (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ç”¨é¢œè‰²)

            // B. ç»˜åˆ¶ç…§ç‰‡åŒºåŸŸ (é»‘è‰²åº•æ¡†)
            // ç…§ç‰‡é€šå¸¸æ˜¯æ–¹å½¢ï¼Œç•™è¾¹ï¼šå·¦å³30pxï¼Œä¸Š30pxï¼Œä¸‹140px
            const photoSize = 540; // 600 - 30 - 30
            const photoX = 30;
            const photoY = 30;
            
            ctx.fillStyle = '#111';
            ctx.fillRect(photoX, photoY, photoSize, photoSize);

            // C. ç»˜åˆ¶å›¾åƒå†…å®¹
            // éœ€è¦è®¡ç®— crop (ç±»ä¼¼ object-fit: cover)
            let source = useStaticImage ? previewImg : video;
            let sw, sh;
            if (useStaticImage) {
                sw = source.naturalWidth;
                sh = source.naturalHeight;
            } else {
                sw = video.videoWidth;
                sh = video.videoHeight;
                if (!sw) return; // è§†é¢‘æœªå‡†å¤‡å¥½
            }

            const sRatio = sw / sh;
            // ç›®æ ‡æ¯”ä¾‹æ˜¯ 1:1 (photoSize/photoSize)
            let sx, sy, sSize;

            if (sRatio > 1) {
                // å®½å›¾ï¼Œè£ä¸­é—´
                sSize = sh;
                sx = (sw - sh) / 2;
                sy = 0;
            } else {
                // é•¿å›¾ï¼Œè£ä¸­é—´
                sSize = sw;
                sx = 0;
                sy = (sh - sw) / 2;
            }

            ctx.save();
            // å¦‚æœæ˜¯å‰ç½®æ‘„åƒå¤´æ‹ç…§ï¼Œéœ€è¦é•œåƒç¿»è½¬å›æ¥
            if (!useStaticImage && isFrontCam) {
                ctx.translate(photoX + photoSize, photoY);
                ctx.scale(-1, 1);
                ctx.drawImage(source, sx, sy, sSize, sSize, 0, 0, photoSize, photoSize);
            } else {
                ctx.drawImage(source, sx, sy, sSize, sSize, photoX, photoY, photoSize, photoSize);
            }
            ctx.restore();

            // D. æ·»åŠ å¤å¤æ»¤é•œå±‚ (åœ¨Canvasä¸Šç›´æ¥å åŠ åŠé€æ˜å±‚)
            // 1. æ™•å½± (Vignette)
            const grad = ctx.createRadialGradient(cw/2, photoY + photoSize/2, photoSize/3, cw/2, photoY + photoSize/2, photoSize*0.7);
            grad.addColorStop(0, 'rgba(0,0,0,0)');
            grad.addColorStop(1, 'rgba(0,0,0,0.4)');
            ctx.fillStyle = grad;
            ctx.fillRect(photoX, photoY, photoSize, photoSize);

            // 2. æš–è‰²è°ƒ
            ctx.fillStyle = 'rgba(200, 150, 100, 0.15)';
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillRect(photoX, photoY, photoSize, photoSize);
            ctx.globalCompositeOperation = 'source-over';

            // E. ç»˜åˆ¶æ–‡å­— (æ‰‹å†™æ—¥æœŸ)
            ctx.fillStyle = '#444';
            ctx.font = '40px "Cedarville Cursive", cursive';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const dateStr = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            ctx.fillText(dateStr, cw/2, photoY + photoSize + 60); // å†™åœ¨åº•éƒ¨ç©ºç™½å¤„

            // F. ç”Ÿæˆå›¾ç‰‡
            const finalImgData = canvas.toDataURL('image/jpeg', 0.9);
            createPolaroidElement(finalImgData);
        }

        // --- 4. ç”Ÿæˆ DOM å…ƒç´ ä¸äº¤äº’ ---
        function createPolaroidElement(imgUrl) {
            const card = document.createElement('div');
            card.className = 'polaroid-card';
            
            // åˆå§‹ä½ç½®ï¼šå‡ºç‰‡å£
            const slotRect = slotRef.getBoundingClientRect();
            // è®¡ç®—å±…ä¸­åç§»
            const startLeft = slotRect.left + (slotRect.width / 2);
            const startTop = slotRect.top;
            
            card.style.left = startLeft + 'px';
            card.style.top = startTop + 'px';

            // å†…éƒ¨ç»“æ„ï¼šä¸€å¼ å®Œæ•´çš„åˆæˆå›¾ + ä¸‹è½½æŒ‰é’®
            card.innerHTML = `
                <img src="${imgUrl}" class="polaroid-img" alt="Polaroid">
                <div class="save-btn" title="ä¿å­˜">â¬‡</div>
            `;

            document.body.appendChild(card);

            // å¼ºåˆ¶å›æµåæ·»åŠ åŠ¨ç”»
            requestAnimationFrame(() => {
                card.classList.add('ejecting');
            });

            // ç»‘å®šäº‹ä»¶
            setupInteraction(card, imgUrl);
        }

        // --- 5. æ‹–æ‹½ä¸ä¿å­˜é€»è¾‘ ---
        let zIndexCounter = 100;

        function setupInteraction(card, imgUrl) {
            const saveBtn = card.querySelector('.save-btn');
            
            // A. ä¿å­˜åŠŸèƒ½
            saveBtn.addEventListener('touchstart', (e) => { e.stopPropagation(); downloadImg(imgUrl); });
            saveBtn.addEventListener('click', (e) => { e.stopPropagation(); downloadImg(imgUrl); });

            // B. æ‹–æ‹½åŠŸèƒ½ (å…¼å®¹ Mouse å’Œ Touch)
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const startHandler = (e) => {
                // å¦‚æœç‚¹çš„æ˜¯ä¿å­˜æŒ‰é’®ï¼Œä¸æ‹–æ‹½
                if (e.target.closest('.save-btn')) return;

                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                isDragging = true;
                
                // ç§»é™¤å¼¹å‡ºåŠ¨ç”»ï¼Œå›ºå®šä½ç½®
                card.classList.remove('ejecting');
                
                // æé«˜å±‚çº§
                zIndexCounter++;
                card.style.zIndex = zIndexCounter;

                // è·å–è§¦ç‚¹
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // è·å–å½“å‰ç»å¯¹ä½ç½®
                const rect = card.getBoundingClientRect();
                // å¦‚æœæ˜¯åŠ¨ç”»ä¸­è¢«æ‰“æ–­ï¼Œéœ€è¦ä¿®æ­£ style
                if (!card.style.left || card.classList.contains('ejecting')) {
                    card.style.left = rect.left + 'px';
                    card.style.top = rect.top + 'px';
                }

                startX = clientX;
                startY = clientY;
                initialLeft = parseFloat(card.style.left);
                initialTop = parseFloat(card.style.top);
            };

            const moveHandler = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const dx = clientX - startX;
                const dy = clientY - startY;

                card.style.left = (initialLeft + dx) + 'px';
                card.style.top = (initialTop + dy) + 'px';
            };

            const endHandler = () => {
                isDragging = false;
            };

            // ç»‘å®š Touch
            card.addEventListener('touchstart', startHandler, {passive: false});
            window.addEventListener('touchmove', moveHandler, {passive: false});
            window.addEventListener('touchend', endHandler);

            // ç»‘å®š Mouse
            card.addEventListener('mousedown', startHandler);
            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('mouseup', endHandler);
        }

        // ä¸‹è½½è¾…åŠ©å‡½æ•°
        function downloadImg(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'polaroid_' + Date.now() + '.jpg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMsg("å·²å¼€å§‹ä¸‹è½½ ğŸ’¾");
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMsg(txt) {
            msgBox.textContent = txt;
            msgBox.style.opacity = 1;
            setTimeout(() => msgBox.style.opacity = 0, 2000);
        }

    </script>
</body>
</html>